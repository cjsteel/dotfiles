setxkbmap \
    -rules evdev \
    -model pc105 \
    -layout hu \
    -option
#    -option lv3:alt_switch -option terminate:ctrl_alt_bksp \
#    -option altwin:swap_lalt_lwin -option altwin:alt_super_win

if [ -f "$HOME/.layout.xkb" ]; then
    xkbcomp $HOME/.layout.xkb $DISPLAY
fi

xset b off

type "synclient" > /dev/null 2>&1 && while :; do
    synclient TapButton1=1
    synclient TapButton2=3
    synclient TapButton3=2
    synclient VertTwoFingerScroll=1
    synclient LockedDrags=1
    synclient LockedDragTimeout=500
    synclient PalmDetect=1
    break
done

if [ -f "$HOME/.Xdefaults" ]; then
    xrdb $HOME/.Xdefaults
fi

for p in $(pidof gnome-screensaver conky trayer skype nm-applet chrome \
           autocutsel parcellite); do
    kill $p
done

type "xscreensaver" > /dev/null 2>&1 && while :; do
    xscreensaver-command -exit
    xscreensaver -no-splash &
    break
done

type "gnome-keyring-daemon" > /dev/null 2>&1 && while :; do
    eval "$(gnome-keyring-daemon -r)"
    export GNOME_KEYRING_CONTROL
    export SSH_AUTH_SOCK
    export GPG_AGENT_INFO
    export GNOME_KEYRING_PID
    break
done

type "trayer" > /dev/null 2>&1 && trayer --widthtype request --align right \
    --height 32 --transparent true --alpha 0 --tint 0x0B0B0B &

type "skype" > /dev/null 2>&1 && while :; do
    (sleep 3 && PULSE_LATENCY_MSEC=30 skype &)
    break
done

type "dropbox" > /dev/null 2>&1 && (dropbox stop; dropbox start &)

type "nm-applet" > /dev/null 2>&1 && nm-applet &

type "devmon" > /dev/null 2>&1 && devmon &

type "parcellite" > /dev/null 2>&1 && while :; do
    parcellite > /dev/null 2>&1 &
    break
done

FIREFOX="$HOME/.local/bin/firefox"
type "$FIREFOX" > /dev/null 2>&1 || FIREFOX="iceweasel"
type "$FIREFOX" > /dev/null 2>&1 && while :; do
    if [ -n "$(pidof $FIREFOX)" ]; then
        break
    fi
    (sleep 10 && $FIREFOX) &
    break
done

XFLUX=$HOME/.local/bin/xflux
type $XFLUX > /dev/null 2>&1 && while :; do
    if [ -n "$(pidof xflux)" ]; then
        break
    fi
    geo=$(curl 'http://www.geobytes.com/IpLocator.htm?GetLocation&template=php3.txt')
    lat=$(echo "$geo"|tr '\r' '\n'|grep latitude|sed 's/.*content="([0-9.,]+)".*/\1/')
    lon=$(echo "$geo"|tr '\r' '\n'|grep longitude|sed 's/.*content="([0-9.,]+)".*/\1/')
    if [ -z "$lat" ]; then
        lat="47.4925"
    fi
    if [ -z "$lon" ]; then
        lon="19.0514"
    fi
    $XFLUX -l $lat -g $lon
    break
done

N_SCREENS=$(xrandr|grep '\<connected\>'|wc -l)
for screen in $(seq 1 $N_SCREENS); do
    type "conky" > /dev/null 2>&1 && type "dzen2" > /dev/null 2>&1 && while :; do
        export FG='white'
        export BG='#002b36'
        export FONT='-*-terminus-medium-r-*-*-14-*-*-*-*-*-*-*'
        export LC_ALL=hu_HU.UTF-8
        (sleep 5 && conky -c $HOME/.conkyrc | dzen2 -e - -x '500' -ta r -fg $FG \
            -bg $BG -fn $FONT -xs $screen) &
        break
    done
done
